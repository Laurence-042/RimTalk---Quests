<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <GameVersion Condition=" '$(GameVersion)' == '' ">1.6</GameVersion>
        <OutputType>Library</OutputType>
        <TargetFramework>net48</TargetFramework>
        <PlatformTarget>x64</PlatformTarget>
        <RootNamespace>RimTalkQuests</RootNamespace>
        <AssemblyName>RimTalkQuests</AssemblyName>
        <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>

        <RimWorldDir Condition=" '$(RimWorldDir)' == '' ">$(RIMWORLD_DIR)</RimWorldDir>

        <OutputPath>$(GameVersion)/Assemblies</OutputPath>
        <ModFolderName>RimTalk-Quests</ModFolderName>
        <LangVersion>latest</LangVersion>
    </PropertyGroup>

    <!-- Define version constants based on GameVersion -->
    <PropertyGroup>
        <DefineConstants>$(DefineConstants);V$(GameVersion.Replace('.', '_'))</DefineConstants>
    </PropertyGroup>

    <!-- Release build configuration -->
    <PropertyGroup Condition=" '$(Configuration)' == 'Release' ">
        <Optimize>true</Optimize>
        <DebugSymbols>false</DebugSymbols>
        <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    </PropertyGroup>

    <!-- Debug build configuration -->
    <PropertyGroup Condition=" '$(Configuration)' == 'Debug' ">
        <Optimize>false</Optimize>
        <DebugSymbols>true</DebugSymbols>
        <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="Lib.Harmony.Ref" Version="2.*" PrivateAssets="All"/>
    </ItemGroup>

    <!-- Use reference assemblies by default (for other users and CI) -->
    <ItemGroup Condition=" '$(UseLocalDlls)' != 'true' ">
        <!-- Core RimWorld & UnityEngine libraries -->
        <PackageReference Include="Krafs.Rimworld.Ref" Version="$(GameVersion).*-*" PrivateAssets="All" />
    </ItemGroup>

    <!-- Reference actual game assemblies when UseLocalDlls is enabled -->
    <ItemGroup Condition=" '$(UseLocalDlls)' == 'true' AND '$(RimWorldDir)' != '' ">
        <Reference Include="Assembly-CSharp">
            <HintPath Condition=" '$(OS)' == 'Windows_NT' ">$(RimWorldDir)\RimWorldWin64_Data\Managed\Assembly-CSharp.dll</HintPath>
            <HintPath Condition=" '$(OS)' != 'Windows_NT' ">$(RimWorldDir)/RimWorldMac.app/Contents/Resources/Data/Managed/Assembly-CSharp.dll</HintPath>
            <Private>false</Private>
        </Reference>

        <_UnityAssemblies Include="$(RimWorldDir)\RimWorldWin64_Data\Managed\UnityEngine*.dll" Condition=" '$(OS)' == 'Windows_NT' " />
        <_UnityAssemblies Include="$(RimWorldDir)/RimWorldMac.app/Contents/Resources/Data/Managed/UnityEngine*.dll" Condition=" '$(OS)' != 'Windows_NT' " />

        <Reference Include="@(_UnityAssemblies)">
            <Private>false</Private>
        </Reference>
    </ItemGroup>

    <!-- Compute paths for RimTalk assembly references -->
    <PropertyGroup Condition=" '$(UseLocalDlls)' == 'true' AND '$(RimWorldDir)' != '' ">
        <!-- RimWorld is in: steamapps/common/RimWorld, Workshop is in: steamapps/workshop/content/... -->
        <SteamAppsDir>$([System.IO.Path]::GetFullPath('$(RimWorldDir)\..\..'))</SteamAppsDir>
        <WorkshopRimTalkDll>$(SteamAppsDir)\workshop\content\294100\3551203752\$(GameVersion)\Assemblies\RimTalk.dll</WorkshopRimTalkDll>
        <LocalRimTalkDll>$(RimWorldDir)\Mods\RimTalk\$(GameVersion)\Assemblies\RimTalk.dll</LocalRimTalkDll>
        
        <!-- Allow override via RimTalkDll parameter -->
        <RimTalkDllPath Condition=" '$(RimTalkDll)' != '' ">$(RimTalkDll)</RimTalkDllPath>
        <RimTalkDllPath Condition=" '$(RimTalkDll)' == '' AND Exists('$(WorkshopRimTalkDll)') ">$(WorkshopRimTalkDll)</RimTalkDllPath>
        <RimTalkDllPath Condition=" '$(RimTalkDll)' == '' AND !Exists('$(WorkshopRimTalkDll)') AND Exists('$(LocalRimTalkDll)') ">$(LocalRimTalkDll)</RimTalkDllPath>
    </PropertyGroup>

    <!-- Reference RimTalk assembly from computed path -->
    <ItemGroup Condition=" '$(UseLocalDlls)' == 'true' AND '$(RimTalkDllPath)' != '' ">
        <Reference Include="RimTalk">
            <HintPath>$(RimTalkDllPath)</HintPath>
            <Private>false</Private>
        </Reference>
    </ItemGroup>

    <!-- Warning if RimTalk not found -->
    <Target Name="CheckRimTalkReference" BeforeTargets="BeforeBuild" Condition=" '$(UseLocalDlls)' == 'true' AND '$(RimWorldDir)' != '' AND '$(RimTalkDllPath)' == '' ">
        <Warning Text="RimTalk.dll not found! Check Workshop (3551203752) or local Mods folder, or use -RimTalkPath parameter" />
    </Target>

    <!-- Exclude ref directory from compilation -->
    <ItemGroup>
        <Compile Remove="ref\**" />
        <EmbeddedResource Remove="ref\**" />
        <None Remove="ref\**" />
    </ItemGroup>

    <!-- Deploy to RimWorld client -->
    <Target Name="DeployToModsFolder" AfterTargets="Build" Condition=" '$(BuildingWithScript)' != 'true' AND '$(RimWorldDir)' != '' ">
        <CallTarget Targets="WinDeploy" Condition=" '$(OS)' == 'Windows_NT' "/>
        <CallTarget Targets="MacDeploy" Condition=" '$(OS)' != 'Windows_NT' "/>
    </Target>

    <!-- Deploy to RimWorld client (macOS) -->
    <Target Name="MacDeploy">
        <PropertyGroup>
            <DeployPath>$(RimWorldDir)/RimWorldMac.app/Mods/RimTalk-Quests/</DeployPath>
        </PropertyGroup>
        <MakeDir Directories="$(DeployPath)"/>
        <Exec Command='rsync -a --delete --checksum "$(ProjectDir)About/"     "$(DeployPath)About/"'/>
        <Exec Command='rsync -a --delete --checksum "$(ProjectDir)Defs/"      "$(DeployPath)Defs/"' Condition="Exists('$(ProjectDir)Defs')"/>
        <Exec Command='rsync -a --delete --checksum "$(ProjectDir)Languages/" "$(DeployPath)Languages/"' Condition="Exists('$(ProjectDir)Languages')"/>
        <Exec Command='rsync -a --delete --checksum "$(ProjectDir)Textures/"  "$(DeployPath)Textures/"' Condition="Exists('$(ProjectDir)Textures')"/>
        <Exec Command='rsync -a --delete --checksum "$(ProjectDir)$(GameVersion)/"       "$(DeployPath)$(GameVersion)/"'/>
        <Message Text="--- macOS deployment finished successfully ---" Importance="high"/>
    </Target>

    <!-- Deploy to RimWorld client (Windows) -->
    <Target Name="WinDeploy">
        <PropertyGroup>
            <WinModPath>$(RimWorldDir)\Mods\RimTalk-Quests\</WinModPath>
        </PropertyGroup>
        <Message Text="Copying to $(WinModPath)" Importance="high"/>
        <ItemGroup>
            <_CopyDirs Include="About;$(GameVersion)"/>
            <_CopyDirs Include="Defs" Condition="Exists('$(ProjectDir)Defs')"/>
            <_CopyDirs Include="Languages" Condition="Exists('$(ProjectDir)Languages')"/>
            <_CopyDirs Include="Textures" Condition="Exists('$(ProjectDir)Textures')"/>
        </ItemGroup>
        <MakeDir Directories="$(WinModPath)"/>
        <Exec Command='robocopy /MIR "$(ProjectDir)%(_CopyDirs.Identity)" "$(WinModPath)%(_CopyDirs.Identity)" /XO /NDL /NJH /NJS /nc /ns /np'
              IgnoreExitCode="true"
              ContinueOnError="true"/>
        <Message Text="--- Windows deployment finished successfully ---" Importance="high"/>
    </Target>

</Project>
